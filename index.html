<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>常用网站导航</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; transition: all 0.28s ease; font-family: "Segoe UI", sans-serif; }
    body {
      height: 100vh; overflow: hidden; display: flex; flex-direction: column; align-items: center; justify-content: center;
      background: radial-gradient(circle at top, #111 0%, #000 100%); color: #fff;
    }
    body.light { background: radial-gradient(circle at top, #fff 0%, #ddd 100%); color: #111; }

    h1 { font-size: 2.6em; letter-spacing: 2px; text-shadow: 0 0 15px #00ffe1; animation: glow 2s infinite alternate; margin-bottom: 10px; }
    @keyframes glow { from { text-shadow: 0 0 10px #00ffe1; } to { text-shadow: 0 0 25px #00ffe1; } }

    .author { font-size: 1em; margin-bottom: 40px; opacity: .85; cursor: pointer; }
    .author:hover { transform: scale(1.05); text-shadow: 0 0 10px #00ffe1; }

    .buttons {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
      gap: 20px;
      width: 80%;
      max-width: 720px;
    }

    .btn {
      background: #111; border: 2px solid #00ffe1; border-radius: 15px; padding: 15px 22px; text-align: center;
      font-size: 1.05em; color: #00ffe1; cursor: grab; box-shadow: 0 0 10px #00ffe1 inset;
      opacity: 0; transform: translateY(30px); position: relative; overflow: hidden;
      animation: flyIn 0.6s forwards, breathe 3s 0.6s infinite ease-in-out;
      user-select: none;
    }
    @keyframes flyIn { from { opacity: 0; transform: translateY(50px); } to { opacity: 1; transform: translateY(0); } }
    @keyframes breathe { 0%, 100% { box-shadow: 0 0 8px #00ffe1 inset; } 50% { box-shadow: 0 0 20px #00ffe1 inset; } }

    .btn:hover { background: #fff; color: transparent; transform: scale(1.08); box-shadow: 0 0 20px #fff, 0 0 40px #fff; }

    .btn img {
      position: absolute; width: 26px; height: 26px; top: 50%; left: 50%;
      transform: translate(-50%, -50%) scale(0); transition: transform .25s ease, opacity .25s ease;
      opacity: 0; pointer-events: none; z-index: 2;
    }
    .btn:hover img { transform: translate(-50%, -50%) scale(1); opacity: 1; }

    .btn span { position: relative; z-index: 1; transition: opacity .18s ease; display: inline-block; }
    .btn:hover span { opacity: 0; }

    body.light .btn {
      background: #f7f7f7; border: 2px solid #0077ff; color: #0077ff; box-shadow: 0 0 10px #0077ff22 inset;
    }
    body.light .btn:hover {
      background: #fff; color: transparent; transform: scale(1.08);
      box-shadow: 0 0 20px #0077ff55, 0 0 40px #0077ff33;
    }

    .theme-toggle, .auth-toggle {
      position: absolute; top: 20px; right: 25px;
      background: transparent; border: 2px solid #00ffe1; color: #00ffe1;
      padding: 8px 14px; border-radius: 10px; cursor: pointer; font-size: 0.95em;
    }
    .theme-toggle { right: 140px; } /* 调整位置，避免重叠 */
    .theme-toggle:hover, .auth-toggle:hover { background: #00ffe1; color: #111; transform: scale(1.05); }
    body.light .theme-toggle, body.light .auth-toggle { border: 2px solid #0077ff; color: #0077ff; }
    body.light .theme-toggle:hover, body.light .auth-toggle:hover { background: #0077ff; color: #fff; }

    canvas {
      position: fixed;
      top: 0; left: 0;
      z-index: -1;
    }

    .loading-text {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 1.5em;
      color: #fff;
      text-shadow: 0 0 10px #00ffe1;
      opacity: 0;
      transition: opacity 0.4s ease;
      z-index: 2000;
      pointer-events: none;
    }

    @media (max-width: 480px) { .buttons { gap: 12px; } .btn { padding: 12px; } h1 { font-size: 1.9rem; } }
  </style>
</head>
<body>
  <canvas id="bg"></canvas>
  <button class="theme-toggle" id="themeBtn">🌗 模式切换</button>
  <button class="auth-toggle" id="authBtn">登录 / 登出</button>
  <h1>常用网站导航</h1>
  <div class="author" onclick="window.open('https://github.com/GuqiUwU','_blank')">作者：鼓启</div>

  <div class="buttons" id="siteContainer"></div>

  <div class="loading-text" id="loading">加载中</div>

  <!-- 先加载 SortableJS（全局，非模块） -->
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>

  <!-- Firebase SDK -->
  <script type="module">
    // Firebase 配置（你的已填）
    const firebaseConfig = {
      apiKey: "AIzaSyCTHV1uUX2dh0RECjbC9wNjvLPJ1lvp74E",
      authDomain: "guqis-menu.firebaseapp.com",
      projectId: "guqis-menu",
      storageBucket: "guqis-menu.firebasestorage.app",
      messagingSenderId: "846795854563",
      appId: "1:846795854563:web:7a8c86d08076dd0edf2bd6"
    };

    // 初始化 Firebase
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js';
    import { getAuth, signInWithPopup, signOut, GoogleAuthProvider, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.13.1/firebase-auth.js';
    import { getFirestore, doc, getDoc, setDoc } from 'https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js';

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const provider = new GoogleAuthProvider();

    let currentUser = null;
    let sortable = null; // Sortable 实例
    const defaultSites = [
      { name: "Google", url: "https://www.google.com" },
      { name: "YouTube", url: "https://www.youtube.com" },
      { name: "Bilibili", url: "https://www.bilibili.com" },
      { name: "GitHub", url: "https://github.com" },
      { name: "ChatGPT", url: "https://chat.openai.com" },
      { name: "SG-MiniRun", url: "https://guqiuwu.github.io/SG-MiniRun" },
      { name: "Twitch", url: "https://www.twitch.tv" },
      { name: "X", url: "https://x.com" },
      { name: "Gmail", url: "https://mail.google.com" },
      { name: "谷歌翻译", url: "https://translate.google.com" },
    ];

    const siteContainer = document.getElementById("siteContainer");
    const authBtn = document.getElementById("authBtn");
    const themeBtn = document.getElementById("themeBtn");

    // 监听登录状态
    onAuthStateChanged(auth, (user) => {
      currentUser = user;
      authBtn.textContent = user ? `👋 ${user.displayName || '用户'} (登出)` : '登录 / 登出';
      loadSites();
    });

    // 加载站点：优先云端
    async function loadSites() {
      let sites = defaultSites;
      const saved = JSON.parse(localStorage.getItem("sitesOrder") || "[]");
      sites = saved.length ? saved : sites;

      if (currentUser) {
        try {
          const userDoc = await getDoc(doc(db, "users", currentUser.uid));
          if (userDoc.exists()) {
            sites = userDoc.data().sitesOrder || sites;
          }
        } catch (error) {
          console.error("加载云端数据失败:", error);
        }
      }

      renderSites(sites);
      initSortable(); // 初始化拖拽
    }

    function renderSites(sitesToRender) {
      siteContainer.innerHTML = "";
      sitesToRender.forEach((site, i) => {
        const div = document.createElement("div");
        div.className = "btn";
        div.style.animationDelay = `${0.1 + i * 0.15}s`;
        div.innerHTML = `<span>${site.name}</span>
          <img src="https://icons.duckduckgo.com/ip3/${new URL(site.url).hostname}.ico" alt="${site.name}">
        `;
        div.onclick = () => go(site.url);
        siteContainer.appendChild(div);
      });
    }

    // 保存站点：云端或本地
    async function saveSites(newOrder) {
      if (currentUser) {
        try {
          await setDoc(doc(db, "users", currentUser.uid), { sitesOrder: newOrder }, { merge: true });
        } catch (error) {
          console.error("保存云端数据失败:", error);
          localStorage.setItem("sitesOrder", JSON.stringify(newOrder)); // fallback
        }
      } else {
        localStorage.setItem("sitesOrder", JSON.stringify(newOrder));
      }
    }

    // 拖拽排序 + 保存（用全局 Sortable）
    function initSortable() {
      if (sortable) sortable.destroy();
      if (typeof Sortable !== 'undefined') {
        sortable = new Sortable(siteContainer, {
          animation: 200,
          ghostClass: 'dragging',
          onEnd: function () {
            const newOrder = [];
            siteContainer.querySelectorAll(".btn span").forEach(el => {
              const name = el.textContent;
              const site = defaultSites.find(s => s.name === name);
              if (site) newOrder.push(site);
            });
            saveSites(newOrder);
          }
        });
      } else {
        console.error('Sortable 未加载');
      }
    }

    // 认证处理
    async function handleAuth() {
      if (currentUser) {
        try {
          await signOut(auth);
        } catch (error) {
          console.error("登出失败:", error);
        }
      } else {
        try {
          await signInWithPopup(auth, provider);
        } catch (error) {
          console.error("登录失败:", error);
          alert("登录失败，请重试！");
        }
      }
    }

    // 主题切换
    function toggleTheme() {
      document.body.classList.toggle("light");
      localStorage.setItem("theme", document.body.classList.contains("light") ? "light" : "dark");
    }
    if (localStorage.getItem("theme") === "light") document.body.classList.add("light");

    // go 函数（不变，略...）
    async function go(url) {
      // ... 你的原 go 函数代码 ...
      // （复制你原代码的 go 函数到这里，保持不变）
    }

    // 粒子动画（不变，略...）
    // ... 你的原粒子代码 ...

    // 绑定事件（用 addEventListener 解决作用域问题）
    authBtn.addEventListener('click', handleAuth);
    themeBtn.addEventListener('click', toggleTheme);

    // 初始加载
    loadSites();
  </script>
</body>
</html>